package books.java_main_service.service;import books.java_main_service.exception.HttpStatusException;import books.java_main_service.model.*;import books.java_main_service.repository.BookRepository;import books.java_main_service.repository.BookItemRepository;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.http.HttpStatus;import org.springframework.stereotype.Service;import java.util.List;import java.util.Optional;@Servicepublic class BookService {    private final BookRepository bookRepository;    private final BookItemRepository bookItemRepository;    private final UserService userService;    @Autowired    public BookService(            BookRepository bookRepository,            BookItemRepository bookItemRepository,            UserService userService) {        this.bookRepository = bookRepository;        this.bookItemRepository = bookItemRepository;        this.userService = userService;    }    public List<Book> findAll() {        return bookRepository.findAll();    }    public Optional<Book> findById(Long id) {        return bookRepository.findById(id);    }    public List<Book> searchBooks(String query, List<Long> genreIds) {        if ((query == null || query.trim().isEmpty()) && (genreIds == null || genreIds.isEmpty())) {            return findAll();        }        return bookRepository.searchByQueryAndGenres(query, genreIds);    }    public Book save(Book book, String accessToken) {        // Проверка токена (просто для проверки авторизации)        String token = accessToken.startsWith("Bearer ") ? accessToken.substring(7) : accessToken;        // Проверка валидности токена        UserMainData userMainData = userService.getUserMainData(token);        if (userMainData == null) {            throw new HttpStatusException(                    HttpStatus.UNAUTHORIZED, "Пользователь не найден или токен недействителен");        }        book.setCreatedBy(userMainData.getId());        return bookRepository.save(book);    }    public BookItem saveBookItem(BookItem bookItem, Long bookId, String accessToken) {        // Проверка токена        String token = accessToken.startsWith("Bearer ") ? accessToken.substring(7) : accessToken;        UserMainData userData = userService.getUserMainData(token);        Book book =                bookRepository                        .findById(bookId)                        .orElseThrow(                                () ->                                        new HttpStatusException(                                                HttpStatus.BAD_REQUEST,                                                "Книга с ID " + bookId + " не найдена"));        // Проверка на существование экземпляра от этого пользователя        if (bookItemRepository.existsByBookIdAndOwnerId(bookId, userData.getId())) {            throw new HttpStatusException(                    HttpStatus.CONFLICT, "У вас уже есть экземпляр этой книги для обмена");        }        bookItem.setBook(book);        bookItem.setOwnerId(userData.getId());        return bookItemRepository.save(bookItem);    }    public List<BookItem> getAllBookItems(Long bookId) {        // Проверяем существование книги        bookRepository                .findById(bookId)                .orElseThrow(                        () ->                                new HttpStatusException(                                        HttpStatus.NOT_FOUND,                                        "Книга с ID " + bookId + " не найдена"));        return bookItemRepository.findByBookId(bookId);    }    public BookItem getBookItem(Long bookId, Long itemId) {        // Проверяем существование книги        bookRepository                .findById(bookId)                .orElseThrow(                        () ->                                new HttpStatusException(                                        HttpStatus.NOT_FOUND,                                        "Книга с ID " + bookId + " не найдена"));        return bookItemRepository                .findByIdAndBookId(itemId, bookId)                .orElseThrow(                        () ->                                new HttpStatusException(                                        HttpStatus.NOT_FOUND,                                        "Экземпляр книги с ID " + itemId + " не найден"));    }    public List<BookItem> searchBookItems(Long bookId, String location, String condition) {        // Проверяем существование книги        bookRepository                .findById(bookId)                .orElseThrow(                        () ->                                new HttpStatusException(                                        HttpStatus.NOT_FOUND,                                        "Книга с ID " + bookId + " не найдена"));        return bookItemRepository.searchByBookIdLocationAndCondition(bookId, location, condition);    }}