package books.java_main_service.controller;import books.java_main_service.model.*;import books.java_main_service.service.UserService;import io.swagger.v3.oas.annotations.Operation;import io.swagger.v3.oas.annotations.Parameter;import io.swagger.v3.oas.annotations.tags.Tag;import jakarta.servlet.http.Cookie;import jakarta.servlet.http.HttpServletResponse;import jakarta.validation.Valid;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.http.ResponseEntity;import org.springframework.web.bind.annotation.*;@Tag(name = "Users", description = "Users API")@RestController@RequestMapping("/users")public class UserController {    private final UserService userService;    @Autowired    public UserController(UserService userService) {        this.userService = userService;    }    private ResponseEntity<UserProfileDTO> buildTokenResponse(            AuthResult result, HttpServletResponse response) {        // Устанавливаем refresh token в HttpOnly Cookie        Cookie refreshTokenCookie =                new Cookie("refresh_token", result.getTokens().getRefreshToken());        refreshTokenCookie.setHttpOnly(true);        refreshTokenCookie.setSecure(true);        refreshTokenCookie.setPath("/");        refreshTokenCookie.setMaxAge(7 * 24 * 60 * 60); // 7 дней        response.addCookie(refreshTokenCookie);        // Возвращаем access token в заголовке        return ResponseEntity.ok()                .header("Authorization", "Bearer " + result.getTokens().getAccessToken())                .body(result.getUserProfile());    }    @PostMapping("/add")    @Operation(summary = "Создание нового пользователя")    public ResponseEntity<UserProfileDTO> createUser(            @Valid @RequestBody UserLoginDTO user, HttpServletResponse response) {        // Получаем данные юзера и токена        AuthResult result = userService.createUser(user);        return buildTokenResponse(result, response);    }    @PostMapping("/auth")    @Operation(summary = "Аутентификация пользователя по логину")    public ResponseEntity<UserProfileDTO> authUser(            @Valid @RequestBody UserLoginDTO user, HttpServletResponse response) {        // Получаем данные юзера и токена        AuthResult result = userService.authUser(user);        return buildTokenResponse(result, response);    }    @GetMapping("/me")    @Operation(summary = "Получение пользователя по id")    public ResponseEntity<UserProfileDTO> getUser(            @Parameter(hidden = true) @RequestHeader("Authorization") String accessToken) {        // Получаем данные юзера и токена        UserMainData userMainData = userService.getUserMainData(accessToken);        UserProfileDTO result = userService.getUser(userMainData.getId());        return ResponseEntity.ok().body(result);    }    @PutMapping("/{id}")    @Operation(summary = "Изменение пользователя по id")    public ResponseEntity<UserProfileDTO> updateUser(            @PathVariable Long id,            @Valid @RequestBody UserProfileDTO user,            @Parameter(hidden = true) @RequestHeader("Authorization") String accessToken,            HttpServletResponse response) {        // Получаем обновленные данные пользователя        AuthResult result = userService.updateUser(user, id, accessToken);        return buildTokenResponse(result, response);    }    @PostMapping("/{id}/password")    @Operation(summary = "Изменение пароля по id")    public ResponseEntity<UserProfileDTO> updatePasswordUser(            @PathVariable Long id,            @Valid @RequestBody UserUpdatePasswordDTO user,            HttpServletResponse response) {        // Получаем обновленные данные пользователя        TokensDTO result = userService.updatePasswordUser(user, id);        // Устанавливаем refresh token в HttpOnly Cookie        Cookie refreshTokenCookie = new Cookie("refresh_token", result.getRefreshToken());        refreshTokenCookie.setHttpOnly(true);        refreshTokenCookie.setSecure(true);        refreshTokenCookie.setPath("/");        refreshTokenCookie.setMaxAge(7 * 24 * 60 * 60); // 7 дней        response.addCookie(refreshTokenCookie);        // Возвращаем access token в заголовке        return ResponseEntity.ok()                .header("Authorization", "Bearer " + result.getAccessToken())                .build();    }    @PostMapping("/refresh-token")    @Operation(summary = "Обновление access токена")    public ResponseEntity<Void> refreshAccessToken(            @CookieValue("refresh_token") String refreshToken) {        // Обновляем access_token с использованием refresh_token        String newAccessToken = userService.refreshAccessToken(refreshToken);        // Отправляем новый токен в заголовке        return ResponseEntity.ok().header("Authorization", "Bearer " + newAccessToken).build();    }}