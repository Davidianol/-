package books.java_main_service;import books.java_main_service.controller.ReviewController;import books.java_main_service.model.Book;import books.java_main_service.model.Review;import books.java_main_service.service.ReviewService;import com.fasterxml.jackson.databind.ObjectMapper;import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.MockitoAnnotations;import org.springframework.http.MediaType;import org.springframework.test.web.servlet.MockMvc;import org.springframework.test.web.servlet.setup.MockMvcBuilders;import org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver;import java.time.LocalDateTime;import java.util.Arrays;import java.util.Collections;import java.util.List;import static org.mockito.ArgumentMatchers.*;import static org.mockito.Mockito.when;import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;class ReviewControllerTest {    private MockMvc mockMvc;    private ObjectMapper objectMapper;    @Mock private ReviewService reviewService;    @InjectMocks private ReviewController reviewController;    private Review testReview;    private String testAccessToken;    @BeforeEach    void setUp() {        MockitoAnnotations.openMocks(this);        // Настройка обработчика исключений        ExceptionHandlerExceptionResolver exceptionResolver =                new ExceptionHandlerExceptionResolver();        exceptionResolver.afterPropertiesSet();        mockMvc =                MockMvcBuilders.standaloneSetup(reviewController)                        .setHandlerExceptionResolvers(exceptionResolver)                        .build();        // Настройка ObjectMapper для поддержки Java 8 date/time типов        objectMapper = new ObjectMapper();        objectMapper.registerModule(new JavaTimeModule());        // Подготовка тестовых данных        Book testBook = new Book();        testBook.setId(1L);        testBook.setTitle("Тестовая книга");        testReview = new Review();        testReview.setId(1L);        testReview.setUserId(1L);        testReview.setBook(testBook);        testReview.setRating(5);        testReview.setDescription("Отличная книга!");        testReview.setCreatedAt(LocalDateTime.now());        testAccessToken = "Bearer test_access_token";    }    @Test    void getAllBookReviews() throws Exception {        List<Review> reviews = Collections.singletonList(testReview);        when(reviewService.getBookReviews(eq(1L), eq(null), eq(null), eq(null)))                .thenReturn(reviews);        mockMvc.perform(get("/books/1/reviews"))                .andExpect(status().isOk())                .andExpect(jsonPath("$[0].id").value(testReview.getId()))                .andExpect(jsonPath("$[0].rating").value(testReview.getRating()))                .andExpect(jsonPath("$[0].description").value(testReview.getDescription()));    }    @Test    void getAllBookReviewsWithFiltering() throws Exception {        List<Review> reviews = Collections.singletonList(testReview);        when(reviewService.getBookReviews(eq(1L), eq(5), eq("rating"), eq("desc")))                .thenReturn(reviews);        mockMvc.perform(                        get("/books/1/reviews")                                .param("rating", "5")                                .param("sortBy", "rating")                                .param("direction", "desc"))                .andExpect(status().isOk())                .andExpect(jsonPath("$[0].id").value(testReview.getId()))                .andExpect(jsonPath("$[0].rating").value(testReview.getRating()));    }    @Test    void getReviewById() throws Exception {        when(reviewService.getReviewById(eq(1L), eq(1L))).thenReturn(testReview);        mockMvc.perform(get("/books/1/reviews/1"))                .andExpect(status().isOk())                .andExpect(jsonPath("$.id").value(testReview.getId()))                .andExpect(jsonPath("$.rating").value(testReview.getRating()))                .andExpect(jsonPath("$.description").value(testReview.getDescription()));    }    @Test    void addReview() throws Exception {        when(reviewService.addReview(eq(1L), any(Review.class), eq(testAccessToken)))                .thenReturn(testReview);        mockMvc.perform(                        post("/books/1/reviews/add")                                .header("Authorization", testAccessToken)                                .contentType(MediaType.APPLICATION_JSON)                                .content(objectMapper.writeValueAsString(testReview)))                .andExpect(status().isCreated())                .andExpect(jsonPath("$.id").value(testReview.getId()))                .andExpect(jsonPath("$.rating").value(testReview.getRating()))                .andExpect(jsonPath("$.description").value(testReview.getDescription()));    }}