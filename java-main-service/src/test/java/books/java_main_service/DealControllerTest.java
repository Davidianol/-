package books.java_main_service;import books.java_main_service.controller.DealController;import books.java_main_service.model.*;import books.java_main_service.service.DealService;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.MockitoAnnotations;import org.springframework.test.web.servlet.MockMvc;import org.springframework.test.web.servlet.setup.MockMvcBuilders;import java.time.LocalDateTime;import java.util.Collections;import java.util.List;import static org.mockito.ArgumentMatchers.*;import static org.mockito.Mockito.when;import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;class DealControllerTest {    private MockMvc mockMvc;    @Mock private DealService dealService;    @InjectMocks private DealController dealController;    private Deal testDeal;    private String testAccessToken;    @BeforeEach    void setUp() {        MockitoAnnotations.openMocks(this);        mockMvc = MockMvcBuilders.standaloneSetup(dealController).build();        // Подготовка тестовых данных        testAccessToken = "Bearer test_access_token";        Book initiatorBook = new Book();        initiatorBook.setId(1L);        initiatorBook.setTitle("Книга инициатора");        Book receiverBook = new Book();        receiverBook.setId(2L);        receiverBook.setTitle("Книга получателя");        BookItem initiatorItem = new BookItem();        initiatorItem.setId(1L);        initiatorItem.setBook(initiatorBook);        initiatorItem.setOwnerId(1L);        initiatorItem.setStatus(BookItem.BookStatus.AVAILABLE);        initiatorItem.setAvailableForDeal(true);        BookItem receiverItem = new BookItem();        receiverItem.setId(2L);        receiverItem.setBook(receiverBook);        receiverItem.setOwnerId(2L);        receiverItem.setStatus(BookItem.BookStatus.AVAILABLE);        receiverItem.setAvailableForDeal(true);        testDeal = new Deal();        testDeal.setId(1L);        testDeal.setInitiatorItem(initiatorItem);        testDeal.setReceiverItem(receiverItem);        testDeal.setInitiatorId(1L);        testDeal.setReceiverId(2L);        testDeal.setStatus(Deal.DealStatus.PROPOSED);        testDeal.setCreatedAt(LocalDateTime.now());    }    @Test    void proposeDeal() throws Exception {        when(dealService.proposeDeal(eq(1L), eq(2L), eq(testAccessToken))).thenReturn(testDeal);        mockMvc.perform(                        post("/deals/propose")                                .header("Authorization", testAccessToken)                                .param("initiatorItemId", "1")                                .param("receiverItemId", "2"))                .andExpect(status().isCreated())                .andExpect(jsonPath("$.id").value(testDeal.getId()))                .andExpect(jsonPath("$.status").value(testDeal.getStatus().toString()));    }    @Test    void acceptDeal() throws Exception {        Deal acceptedDeal = new Deal();        acceptedDeal.setId(testDeal.getId());        acceptedDeal.setInitiatorItem(testDeal.getInitiatorItem());        acceptedDeal.setReceiverItem(testDeal.getReceiverItem());        acceptedDeal.setInitiatorId(testDeal.getInitiatorId());        acceptedDeal.setReceiverId(testDeal.getReceiverId());        acceptedDeal.setStatus(Deal.DealStatus.ACCEPTED);        acceptedDeal.setCreatedAt(testDeal.getCreatedAt());        when(dealService.acceptDeal(eq(1L), eq(testAccessToken))).thenReturn(acceptedDeal);        mockMvc.perform(put("/deals/1/accept").header("Authorization", testAccessToken))                .andExpect(status().isOk())                .andExpect(jsonPath("$.id").value(acceptedDeal.getId()))                .andExpect(jsonPath("$.status").value(acceptedDeal.getStatus().toString()));    }    @Test    void completeDeal() throws Exception {        Deal completedDeal = new Deal();        completedDeal.setId(testDeal.getId());        completedDeal.setInitiatorItem(testDeal.getInitiatorItem());        completedDeal.setReceiverItem(testDeal.getReceiverItem());        completedDeal.setInitiatorId(testDeal.getInitiatorId());        completedDeal.setReceiverId(testDeal.getReceiverId());        completedDeal.setStatus(Deal.DealStatus.COMPLETED);        completedDeal.setCreatedAt(testDeal.getCreatedAt());        completedDeal.setCompletedAt(LocalDateTime.now());        when(dealService.completeDeal(eq(1L), eq(testAccessToken))).thenReturn(completedDeal);        mockMvc.perform(put("/deals/1/complete").header("Authorization", testAccessToken))                .andExpect(status().isOk())                .andExpect(jsonPath("$.id").value(completedDeal.getId()))                .andExpect(jsonPath("$.status").value(completedDeal.getStatus().toString()));    }    @Test    void cancelDeal() throws Exception {        Deal cancelledDeal = new Deal();        cancelledDeal.setId(testDeal.getId());        cancelledDeal.setInitiatorItem(testDeal.getInitiatorItem());        cancelledDeal.setReceiverItem(testDeal.getReceiverItem());        cancelledDeal.setInitiatorId(testDeal.getInitiatorId());        cancelledDeal.setReceiverId(testDeal.getReceiverId());        cancelledDeal.setStatus(Deal.DealStatus.CANCELLED);        cancelledDeal.setCreatedAt(testDeal.getCreatedAt());        when(dealService.cancelDeal(eq(1L), eq(testAccessToken))).thenReturn(cancelledDeal);        mockMvc.perform(put("/deals/1/cancel").header("Authorization", testAccessToken))                .andExpect(status().isOk())                .andExpect(jsonPath("$.id").value(cancelledDeal.getId()))                .andExpect(jsonPath("$.status").value(cancelledDeal.getStatus().toString()));    }    @Test    void getUserDeals() throws Exception {        List<Deal> deals = Collections.singletonList(testDeal);        when(dealService.getUserDeals(eq(testAccessToken))).thenReturn(deals);        mockMvc.perform(get("/deals/user").header("Authorization", testAccessToken))                .andExpect(status().isOk())                .andExpect(jsonPath("$[0].id").value(testDeal.getId()))                .andExpect(jsonPath("$[0].status").value(testDeal.getStatus().toString()));    }}