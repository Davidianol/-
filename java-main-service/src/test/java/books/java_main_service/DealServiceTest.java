package books.java_main_service;import books.java_main_service.exception.HttpStatusException;import books.java_main_service.model.*;import books.java_main_service.repository.BookItemRepository;import books.java_main_service.repository.DealRepository;import books.java_main_service.repository.TotalDealsRepository;import books.java_main_service.service.DealService;import books.java_main_service.service.UserService;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.junit.jupiter.api.extension.ExtendWith;import org.mockito.ArgumentCaptor;import org.mockito.Captor;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.junit.jupiter.MockitoExtension;import org.springframework.http.HttpStatus;import java.util.Collections;import java.util.List;import java.util.Optional;import static org.junit.jupiter.api.Assertions.*;import static org.mockito.ArgumentMatchers.*;import static org.mockito.Mockito.*;@ExtendWith(MockitoExtension.class)class DealServiceTest {    @Mock private DealRepository dealRepository;    @Mock private BookItemRepository bookItemRepository;    @Mock private UserService userService;    @Mock private TotalDealsRepository totalDealsRepository;    @InjectMocks private DealService dealService;    @Captor private ArgumentCaptor<BookItem> bookItemCaptor;    @Captor private ArgumentCaptor<Deal> dealCaptor;    @Captor private ArgumentCaptor<TotalDeals> totalDealsCaptor;    private BookItem initiatorItem;    private BookItem receiverItem;    private Deal testDeal;    private UserMainData initiatorUser;    private UserMainData receiverUser;    private UserMainData thirdPartyUser;    private final String testToken = "Bearer testToken";    private final String rawTestToken = "testToken";    @BeforeEach    void setUp() {        initiatorUser = new UserMainData(1L, "CLIENT");        receiverUser = new UserMainData(2L, "CLIENT");        thirdPartyUser = new UserMainData(3L, "CLIENT");        Book book1 = new Book();        book1.setId(1L);        book1.setTitle("Книга 1");        Book book2 = new Book();        book2.setId(2L);        book2.setTitle("Книга 2");        initiatorItem = new BookItem();        initiatorItem.setId(1L);        initiatorItem.setBook(book1);        initiatorItem.setOwnerId(initiatorUser.getId());        initiatorItem.setStatus(BookItem.BookStatus.AVAILABLE);        initiatorItem.setAvailableForDeal(true);        initiatorItem.setLocation("Location 1");        initiatorItem.setDescription("Description 1");        receiverItem = new BookItem();        receiverItem.setId(2L);        receiverItem.setBook(book2);        receiverItem.setOwnerId(receiverUser.getId());        receiverItem.setStatus(BookItem.BookStatus.AVAILABLE);        receiverItem.setAvailableForDeal(true);        receiverItem.setLocation("Location 2");        receiverItem.setDescription("Description 2");        testDeal = new Deal();        testDeal.setId(1L);        testDeal.setInitiatorItem(initiatorItem);        testDeal.setReceiverItem(receiverItem);        testDeal.setInitiatorId(initiatorUser.getId());        testDeal.setReceiverId(receiverUser.getId());        testDeal.setStatus(Deal.DealStatus.PROPOSED);    }    @Test    void proposeDealShouldThrowExceptionWhenReceiverItemNotFound() {        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(bookItemRepository.findById(initiatorItem.getId()))                .thenReturn(Optional.of(initiatorItem));        when(bookItemRepository.findById(999L)).thenReturn(Optional.empty());        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () -> dealService.proposeDeal(initiatorItem.getId(), 999L, testToken));        assertEquals(HttpStatus.NOT_FOUND, exception.getHttpStatus());        assertTrue(exception.getMessage().contains("Книга получателя не найдена"));    }    @Test    void proposeDealShouldThrowExceptionWhenUserIsNotOwnerOfInitiatorItem() {        UserMainData wrongUser = new UserMainData(999L, "CLIENT");        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(wrongUser);        when(bookItemRepository.findById(initiatorItem.getId()))                .thenReturn(Optional.of(initiatorItem));        when(bookItemRepository.findById(receiverItem.getId()))                .thenReturn(Optional.of(receiverItem));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () ->                                dealService.proposeDeal(                                        initiatorItem.getId(), receiverItem.getId(), testToken));        assertEquals(HttpStatus.FORBIDDEN, exception.getHttpStatus());        assertEquals("Вы не являетесь владельцем этой книги", exception.getMessage());    }    @Test    void proposeDealShouldThrowExceptionWhenInitiatorItemNotAvailableForDeal() {        initiatorItem.setAvailableForDeal(false);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(bookItemRepository.findById(initiatorItem.getId()))                .thenReturn(Optional.of(initiatorItem));        when(bookItemRepository.findById(receiverItem.getId()))                .thenReturn(Optional.of(receiverItem));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () ->                                dealService.proposeDeal(                                        initiatorItem.getId(), receiverItem.getId(), testToken));        assertEquals(HttpStatus.BAD_REQUEST, exception.getHttpStatus());        assertEquals("Обе книги должны быть доступны для обмена", exception.getMessage());    }    @Test    void proposeDealShouldThrowExceptionWhenReceiverItemNotAvailableForDeal() {        receiverItem.setAvailableForDeal(false);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(bookItemRepository.findById(initiatorItem.getId()))                .thenReturn(Optional.of(initiatorItem));        when(bookItemRepository.findById(receiverItem.getId()))                .thenReturn(Optional.of(receiverItem));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () ->                                dealService.proposeDeal(                                        initiatorItem.getId(), receiverItem.getId(), testToken));        assertEquals(HttpStatus.BAD_REQUEST, exception.getHttpStatus());        assertEquals("Обе книги должны быть доступны для обмена", exception.getMessage());    }    @Test    void proposeDealShouldThrowExceptionWhenInitiatorItemStatusNotAvailable() {        initiatorItem.setStatus(BookItem.BookStatus.RESERVED);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(bookItemRepository.findById(initiatorItem.getId()))                .thenReturn(Optional.of(initiatorItem));        when(bookItemRepository.findById(receiverItem.getId()))                .thenReturn(Optional.of(receiverItem));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () ->                                dealService.proposeDeal(                                        initiatorItem.getId(), receiverItem.getId(), testToken));        assertEquals(HttpStatus.BAD_REQUEST, exception.getHttpStatus());        assertEquals("Обе книги должны быть доступны для обмена", exception.getMessage());    }    @Test    void proposeDealShouldCreateDealAndUpdateItemStatus() {        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(bookItemRepository.findById(initiatorItem.getId()))                .thenReturn(Optional.of(initiatorItem));        when(bookItemRepository.findById(receiverItem.getId()))                .thenReturn(Optional.of(receiverItem));        List<Deal.DealStatus> activeStatuses =                List.of(                        Deal.DealStatus.PROPOSED,                        Deal.DealStatus.ACCEPTED,                        Deal.DealStatus.COMPLETED);        when(dealRepository.existsActiveDeal(                        eq(initiatorItem.getId()), eq(receiverItem.getId()), eq(activeStatuses)))                .thenReturn(false);        when(dealRepository.save(any(Deal.class)))                .thenAnswer(                        invocation -> {                            Deal dealToSave = invocation.getArgument(0);                            dealToSave.setId(1L);                            return dealToSave;                        });        when(totalDealsRepository.findById(eq(initiatorUser.getId())))                .thenReturn(Optional.of(new TotalDeals(initiatorUser.getId())));        when(totalDealsRepository.findById(eq(receiverUser.getId())))                .thenReturn(Optional.of(new TotalDeals(receiverUser.getId())));        when(totalDealsRepository.save(any(TotalDeals.class))).thenAnswer(i -> i.getArgument(0));        Deal result =                dealService.proposeDeal(initiatorItem.getId(), receiverItem.getId(), testToken);        assertNotNull(result);        assertEquals(Deal.DealStatus.PROPOSED, result.getStatus());        assertEquals(initiatorUser.getId(), result.getInitiatorId());        assertEquals(receiverUser.getId(), result.getReceiverId());        assertEquals(initiatorItem, result.getInitiatorItem());        assertEquals(receiverItem, result.getReceiverItem());        assertEquals(BookItem.BookStatus.RESERVED, initiatorItem.getStatus());        assertEquals(BookItem.BookStatus.RESERVED, receiverItem.getStatus());        verify(dealRepository).save(dealCaptor.capture());        Deal savedDeal = dealCaptor.getValue();        assertEquals(BookItem.BookStatus.RESERVED, savedDeal.getInitiatorItem().getStatus());        assertEquals(BookItem.BookStatus.RESERVED, savedDeal.getReceiverItem().getStatus());        verify(totalDealsRepository, times(2)).save(totalDealsCaptor.capture());        List<TotalDeals> capturedTotalDeals = totalDealsCaptor.getAllValues();        assertTrue(                capturedTotalDeals.stream()                        .anyMatch(                                td ->                                        td.getUserId().equals(initiatorUser.getId())                                                && td.getTotalDeals() == 1));        assertTrue(                capturedTotalDeals.stream()                        .anyMatch(                                td ->                                        td.getUserId().equals(receiverUser.getId())                                                && td.getTotalDeals() == 1));    }    @Test    void acceptDealShouldUpdateDealStatus() {        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(receiverUser);        when(dealRepository.findById(testDeal.getId())).thenReturn(Optional.of(testDeal));        when(dealRepository.save(any(Deal.class))).thenReturn(testDeal);        Deal result = dealService.acceptDeal(testDeal.getId(), testToken);        assertEquals(Deal.DealStatus.ACCEPTED, result.getStatus());        verify(dealRepository).save(testDeal);    }    @Test    void acceptDealShouldThrowExceptionWhenDealNotFound() {        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(receiverUser);        when(dealRepository.findById(999L)).thenReturn(Optional.empty());        HttpStatusException exception =                assertThrows(                        HttpStatusException.class, () -> dealService.acceptDeal(999L, testToken));        assertEquals(HttpStatus.NOT_FOUND, exception.getHttpStatus());        assertEquals("Сделка не найдена", exception.getMessage());    }    @Test    void acceptDealShouldThrowExceptionWhenUserIsNotParticipant() {        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(thirdPartyUser);        when(dealRepository.findById(testDeal.getId())).thenReturn(Optional.of(testDeal));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () -> dealService.acceptDeal(testDeal.getId(), testToken));        assertEquals(HttpStatus.FORBIDDEN, exception.getHttpStatus());        assertEquals("У вас нет прав на эту сделку", exception.getMessage());    }    @Test    void acceptDealShouldThrowExceptionWhenDealStatusNotProposed() {        testDeal.setStatus(Deal.DealStatus.ACCEPTED);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(receiverUser);        when(dealRepository.findById(testDeal.getId())).thenReturn(Optional.of(testDeal));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () -> dealService.acceptDeal(testDeal.getId(), testToken));        assertEquals(HttpStatus.BAD_REQUEST, exception.getHttpStatus());        assertEquals(                "Некорректный статус сделки. Ожидается: " + Deal.DealStatus.PROPOSED,                exception.getMessage());    }    @Test    void completeDealShouldSwapOwnersAndChangeStatuses() {        testDeal.setStatus(Deal.DealStatus.ACCEPTED);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(dealRepository.findById(testDeal.getId())).thenReturn(Optional.of(testDeal));        when(bookItemRepository.save(any(BookItem.class)))                .thenAnswer(invocation -> invocation.getArgument(0));        when(dealRepository.save(any(Deal.class))).thenReturn(testDeal);        when(totalDealsRepository.findById(initiatorUser.getId()))                .thenReturn(Optional.of(new TotalDeals(initiatorUser.getId())));        when(totalDealsRepository.findById(receiverUser.getId()))                .thenReturn(Optional.of(new TotalDeals(receiverUser.getId())));        Deal result = dealService.completeDeal(testDeal.getId(), testToken);        assertEquals(Deal.DealStatus.COMPLETED, result.getStatus());        assertNotNull(result.getCompletedAt());        verify(bookItemRepository, times(2)).save(bookItemCaptor.capture());        List<BookItem> savedItems = bookItemCaptor.getAllValues();        BookItem finalInitiatorItem =                savedItems.stream()                        .filter(item -> item.getId().equals(initiatorItem.getId()))                        .findFirst()                        .orElseThrow();        BookItem finalReceiverItem =                savedItems.stream()                        .filter(item -> item.getId().equals(receiverItem.getId()))                        .findFirst()                        .orElseThrow();        assertEquals(receiverUser.getId(), finalInitiatorItem.getOwnerId());        assertEquals(initiatorUser.getId(), finalReceiverItem.getOwnerId());        assertEquals(BookItem.BookStatus.AVAILABLE, finalInitiatorItem.getStatus());        assertEquals(BookItem.BookStatus.AVAILABLE, finalReceiverItem.getStatus());        verify(totalDealsRepository, times(2)).save(totalDealsCaptor.capture());        List<TotalDeals> capturedTotalDeals = totalDealsCaptor.getAllValues();        assertTrue(                capturedTotalDeals.stream()                        .anyMatch(                                td ->                                        td.getUserId().equals(initiatorUser.getId())                                                && td.getSuccessfulDeals() == 1));        assertTrue(                capturedTotalDeals.stream()                        .anyMatch(                                td ->                                        td.getUserId().equals(receiverUser.getId())                                                && td.getSuccessfulDeals() == 1));    }    @Test    void completeDealShouldThrowExceptionWhenDealNotInAcceptedStatus() {        testDeal.setStatus(Deal.DealStatus.PROPOSED);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(dealRepository.findById(testDeal.getId())).thenReturn(Optional.of(testDeal));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () -> dealService.completeDeal(testDeal.getId(), testToken));        assertEquals(HttpStatus.BAD_REQUEST, exception.getHttpStatus());        assertEquals(                "Некорректный статус сделки. Ожидается: " + Deal.DealStatus.ACCEPTED,                exception.getMessage());    }    @Test    void getUserDealsShouldReturnUserDeals() {        List<Deal> expectedDeals = Collections.singletonList(testDeal);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(dealRepository.findByInitiatorIdOrReceiverId(                        initiatorUser.getId(), initiatorUser.getId()))                .thenReturn(expectedDeals);        List<Deal> result = dealService.getUserDeals(testToken);        assertEquals(expectedDeals, result);        verify(dealRepository)                .findByInitiatorIdOrReceiverId(initiatorUser.getId(), initiatorUser.getId());    }    @Test    void cancelDealShouldUpdateStatusAndReleaseItems() {        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(initiatorUser);        when(dealRepository.findById(testDeal.getId())).thenReturn(Optional.of(testDeal));        when(dealRepository.save(any(Deal.class))).thenReturn(testDeal);        Deal result = dealService.cancelDeal(testDeal.getId(), testToken);        assertEquals(Deal.DealStatus.CANCELLED, result.getStatus());        assertEquals(BookItem.BookStatus.AVAILABLE, testDeal.getInitiatorItem().getStatus());        assertEquals(BookItem.BookStatus.AVAILABLE, testDeal.getReceiverItem().getStatus());        verify(dealRepository).save(dealCaptor.capture());        Deal savedDeal = dealCaptor.getValue();        assertEquals(Deal.DealStatus.CANCELLED, savedDeal.getStatus());        assertEquals(BookItem.BookStatus.AVAILABLE, savedDeal.getInitiatorItem().getStatus());        assertEquals(BookItem.BookStatus.AVAILABLE, savedDeal.getReceiverItem().getStatus());    }}