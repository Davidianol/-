package books.java_main_service;import books.java_main_service.exception.HttpStatusException;import books.java_main_service.model.Book;import books.java_main_service.model.Review;import books.java_main_service.model.UserMainData;import books.java_main_service.repository.BookRepository;import books.java_main_service.repository.ReviewRepository;import books.java_main_service.service.ReviewService;import books.java_main_service.service.UserService;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.junit.jupiter.api.extension.ExtendWith;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.junit.jupiter.MockitoExtension;import org.springframework.http.HttpStatus;import java.time.LocalDateTime;import java.util.*;import static org.junit.jupiter.api.Assertions.*;import static org.mockito.ArgumentMatchers.*;import static org.mockito.Mockito.*;@ExtendWith(MockitoExtension.class)class ReviewServiceTest {    @Mock private ReviewRepository reviewRepository;    @Mock private BookRepository bookRepository;    @Mock private UserService userService;    @InjectMocks private ReviewService reviewService;    private Book testBook;    private Review testReview;    private UserMainData testUserMainData;    private final String testToken = "Bearer testToken";    private final String rawTestToken = "testToken";    @BeforeEach    void setUp() {        testUserMainData = new UserMainData(1L, "CLIENT");        testBook = new Book();        testBook.setId(1L);        testBook.setTitle("Тестовая книга");        testBook.setReviews(new HashSet<>());        testReview = new Review();        testReview.setId(1L);        testReview.setUserId(1L);        testReview.setBook(testBook);        testReview.setRating(5);        testReview.setDescription("Отличная книга!");        testReview.setCreatedAt(LocalDateTime.now());    }    @Test    void getBookReviewsShouldReturnFilteredReviewsByRating() {        List<Review> expectedReviews = Collections.singletonList(testReview);        when(reviewRepository.findByBookIdAndRatingOrderByCreatedAtDesc(1L, 5))                .thenReturn(expectedReviews);        List<Review> actualReviews = reviewService.getBookReviews(1L, 5, null, null);        assertEquals(expectedReviews, actualReviews);    }    @Test    void getBookReviewsShouldSortByRatingAsc() {        List<Review> expectedReviews = Collections.singletonList(testReview);        when(reviewRepository.findByBookIdOrderByRatingAsc(1L)).thenReturn(expectedReviews);        List<Review> actualReviews = reviewService.getBookReviews(1L, null, "rating", "asc");        assertEquals(expectedReviews, actualReviews);    }    @Test    void getReviewByIdShouldThrowExceptionWhenNotFound() {        when(reviewRepository.findByIdAndBookId(anyLong(), anyLong())).thenReturn(Optional.empty());        HttpStatusException exception =                assertThrows(                        HttpStatusException.class, () -> reviewService.getReviewById(1L, 999L));        assertEquals(HttpStatus.NOT_FOUND, exception.getHttpStatus());    }    @Test    void addReviewShouldThrowExceptionWhenBookNotFound() {        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(testUserMainData);        when(bookRepository.findById(999L)).thenReturn(Optional.empty());        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () -> reviewService.addReview(999L, testReview, testToken));        assertEquals(HttpStatus.NOT_FOUND, exception.getHttpStatus());    }    @Test    void addReviewShouldThrowExceptionWhenUserAlreadyReviewed() {        Review existingReview = new Review();        existingReview.setId(2L);        existingReview.setUserId(testUserMainData.getId());        testBook.getReviews().add(existingReview);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(testUserMainData);        when(bookRepository.findById(1L)).thenReturn(Optional.of(testBook));        HttpStatusException exception =                assertThrows(                        HttpStatusException.class,                        () -> reviewService.addReview(1L, testReview, testToken));        assertEquals(HttpStatus.CONFLICT, exception.getHttpStatus());    }    @Test    void addReviewShouldSaveReviewAndUpdateBookRating() {        Set<Review> reviews = new HashSet<>();        testBook.setReviews(reviews);        when(userService.getUserMainData(eq(rawTestToken))).thenReturn(testUserMainData);        when(bookRepository.findById(1L)).thenReturn(Optional.of(testBook));        when(reviewRepository.save(any(Review.class))).thenReturn(testReview);        when(bookRepository.save(any(Book.class))).thenReturn(testBook);        Review savedReview = reviewService.addReview(1L, testReview, testToken);        assertEquals(testReview, savedReview);        assertEquals(testUserMainData.getId(), savedReview.getUserId());        assertEquals(testBook, savedReview.getBook());        verify(reviewRepository).save(testReview);        verify(bookRepository).save(testBook);        assertTrue(testBook.getReviews().contains(testReview));    }}