package books.java_main_service;import books.java_main_service.controller.UserController;import books.java_main_service.model.*;import books.java_main_service.service.UserService;import com.fasterxml.jackson.databind.ObjectMapper;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.MockitoAnnotations;import org.springframework.http.MediaType;import org.springframework.test.web.servlet.MockMvc;import org.springframework.test.web.servlet.setup.MockMvcBuilders;import static org.mockito.ArgumentMatchers.any;import static org.mockito.ArgumentMatchers.eq;import static org.mockito.Mockito.when;import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;class UserControllerTest {    private MockMvc mockMvc;    private final ObjectMapper objectMapper = new ObjectMapper();    @Mock private UserService userService;    @InjectMocks private UserController userController;    private UserLoginDTO testLoginDTO;    private UserProfileDTO testProfileDTO;    private TokensDTO testTokensDTO;    private AuthResult testAuthResult;    private UserMainData testUserMainData;    private String testAccessToken;    private String testRefreshToken;    @BeforeEach    void setUp() {        MockitoAnnotations.openMocks(this);        mockMvc = MockMvcBuilders.standaloneSetup(userController).build();        // Подготовка тестовых данных        testLoginDTO = new UserLoginDTO("testuser", "password123");        testProfileDTO =                new UserProfileDTO(1L, "testuser", "CLIENT", "test@example.com", "+79123456789");        testAccessToken = "test_access_token";        testRefreshToken = "test_refresh_token";        testTokensDTO = new TokensDTO(testAccessToken, testRefreshToken);        testAuthResult = new AuthResult(testProfileDTO, testTokensDTO);        testUserMainData = new UserMainData(1L, "CLIENT");    }    @Test    void createNewUser() throws Exception {        when(userService.createUser(any(UserLoginDTO.class))).thenReturn(testAuthResult);        mockMvc.perform(                        post("/users/add")                                .contentType(MediaType.APPLICATION_JSON)                                .content(objectMapper.writeValueAsString(testLoginDTO)))                .andExpect(status().isOk())                .andExpect(header().string("Authorization", "Bearer " + testAccessToken))                .andExpect(cookie().exists("refresh_token"))                .andExpect(cookie().value("refresh_token", testRefreshToken))                .andExpect(jsonPath("$.id").value(testProfileDTO.getId()))                .andExpect(jsonPath("$.login").value(testProfileDTO.getLogin()))                .andExpect(jsonPath("$.role").value(testProfileDTO.getRole()));    }    @Test    void authUser() throws Exception {        when(userService.authUser(any(UserLoginDTO.class))).thenReturn(testAuthResult);        mockMvc.perform(                        post("/users/auth")                                .contentType(MediaType.APPLICATION_JSON)                                .content(objectMapper.writeValueAsString(testLoginDTO)))                .andExpect(status().isOk())                .andExpect(header().string("Authorization", "Bearer " + testAccessToken))                .andExpect(cookie().exists("refresh_token"))                .andExpect(cookie().value("refresh_token", testRefreshToken))                .andExpect(jsonPath("$.id").value(testProfileDTO.getId()))                .andExpect(jsonPath("$.login").value(testProfileDTO.getLogin()));    }    @Test    void getUserData() throws Exception {        String bearerToken = "Bearer " + testAccessToken;        when(userService.getUserMainData(eq(bearerToken))).thenReturn(testUserMainData);        when(userService.getUser(eq(testUserMainData.getId()))).thenReturn(testProfileDTO);        mockMvc.perform(get("/users/me").header("Authorization", bearerToken))                .andExpect(status().isOk())                .andExpect(jsonPath("$.id").value(testProfileDTO.getId()))                .andExpect(jsonPath("$.login").value(testProfileDTO.getLogin()))                .andExpect(jsonPath("$.role").value(testProfileDTO.getRole()))                .andExpect(jsonPath("$.mail").value(testProfileDTO.getMail()))                .andExpect(jsonPath("$.phone").value(testProfileDTO.getPhone()));    }    @Test    void updateUserData() throws Exception {        String bearerToken = "Bearer " + testAccessToken;        when(userService.updateUser(any(UserProfileDTO.class), eq(1L), eq(bearerToken)))                .thenReturn(testAuthResult);        mockMvc.perform(                        put("/users/1")                                .header("Authorization", bearerToken)                                .contentType(MediaType.APPLICATION_JSON)                                .content(objectMapper.writeValueAsString(testProfileDTO)))                .andExpect(status().isOk())                .andExpect(header().string("Authorization", "Bearer " + testAccessToken))                .andExpect(cookie().exists("refresh_token"))                .andExpect(cookie().value("refresh_token", testRefreshToken))                .andExpect(jsonPath("$.id").value(testProfileDTO.getId()))                .andExpect(jsonPath("$.login").value(testProfileDTO.getLogin()));    }    @Test    void updateUserPassword() throws Exception {        UserUpdatePasswordDTO passwordDTO = new UserUpdatePasswordDTO("oldPassword", "newPassword");        when(userService.updatePasswordUser(any(UserUpdatePasswordDTO.class), eq(1L)))                .thenReturn(testTokensDTO);        mockMvc.perform(                        post("/users/1/password")                                .contentType(MediaType.APPLICATION_JSON)                                .content(objectMapper.writeValueAsString(passwordDTO)))                .andExpect(status().isOk())                .andExpect(header().string("Authorization", "Bearer " + testAccessToken))                .andExpect(cookie().exists("refresh_token"))                .andExpect(cookie().value("refresh_token", testRefreshToken));    }}