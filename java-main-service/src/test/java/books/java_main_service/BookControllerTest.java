package books.java_main_service;import books.java_main_service.controller.BookController;import books.java_main_service.model.*;import books.java_main_service.service.BookService;import com.fasterxml.jackson.databind.ObjectMapper;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.Test;import org.mockito.InjectMocks;import org.mockito.Mock;import org.mockito.MockitoAnnotations;import org.springframework.http.MediaType;import org.springframework.test.web.servlet.MockMvc;import org.springframework.test.web.servlet.setup.MockMvcBuilders;import java.util.*;import static org.mockito.ArgumentMatchers.*;import static org.mockito.Mockito.when;import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;class BookControllerTest {    private MockMvc mockMvc;    private final ObjectMapper objectMapper = new ObjectMapper();    @Mock private BookService bookService;    @InjectMocks private BookController bookController;    private Book testBook;    private BookItem testBookItem;    private String testAccessToken;    @BeforeEach    void setUp() {        MockitoAnnotations.openMocks(this);        mockMvc = MockMvcBuilders.standaloneSetup(bookController).build();        // Подготовка тестовых данных        Genre testGenre = new Genre();        testGenre.setId(1L);        testGenre.setName("Фантастика");        testBook = new Book();        testBook.setId(1L);        testBook.setTitle("Тестовая книга");        testBook.setAuthor("Тестовый Автор");        testBook.setDescription("Описание тестовой книги");        testBook.setYear(2023);        Set<Genre> genres = new HashSet<>();        genres.add(testGenre);        testBook.setGenres(genres);        testBook.setCreatedBy(1L);        testBookItem = new BookItem();        testBookItem.setId(1L);        testBookItem.setBook(testBook);        testBookItem.setOwnerId(1L);        testBookItem.setCondition(BookItem.BookCondition.MINIMAL_WEAR);        testBookItem.setAvailableForDeal(true);        testBookItem.setLocation("Москва");        testBookItem.setDescription("Тестовый экземпляр книги");        testBookItem.setStatus(BookItem.BookStatus.AVAILABLE);        testAccessToken = "Bearer test_access_token";    }    @Test    void getAllBooks() throws Exception {        List<Book> books = Collections.singletonList(testBook);        when(bookService.findAll()).thenReturn(books);        mockMvc.perform(get("/books"))                .andExpect(status().isOk())                .andExpect(jsonPath("$[0].id").value(testBook.getId()))                .andExpect(jsonPath("$[0].title").value(testBook.getTitle()))                .andExpect(jsonPath("$[0].author").value(testBook.getAuthor()));    }    @Test    void getBookById() throws Exception {        when(bookService.findById(eq(1L))).thenReturn(Optional.of(testBook));        mockMvc.perform(get("/books/1"))                .andExpect(status().isOk())                .andExpect(jsonPath("$.id").value(testBook.getId()))                .andExpect(jsonPath("$.title").value(testBook.getTitle()))                .andExpect(jsonPath("$.author").value(testBook.getAuthor()));    }    @Test    void getBookByIdNotFound() throws Exception {        when(bookService.findById(eq(99L))).thenReturn(Optional.empty());        mockMvc.perform(get("/books/99")).andExpect(status().isNotFound());    }    @Test    void searchBooks() throws Exception {        List<Book> books = Collections.singletonList(testBook);        when(bookService.searchBooks(eq("тест"), anyList())).thenReturn(books);        mockMvc.perform(get("/books/search").param("query", "тест").param("genreIds", "1"))                .andExpect(status().isOk())                .andExpect(jsonPath("$[0].id").value(testBook.getId()))                .andExpect(jsonPath("$[0].title").value(testBook.getTitle()));    }    @Test    void createBook() throws Exception {        when(bookService.save(any(Book.class), eq(testAccessToken))).thenReturn(testBook);        mockMvc.perform(                        post("/books/add")                                .header("Authorization", testAccessToken)                                .contentType(MediaType.APPLICATION_JSON)                                .content(objectMapper.writeValueAsString(testBook)))                .andExpect(status().isCreated())                .andExpect(jsonPath("$.id").value(testBook.getId()))                .andExpect(jsonPath("$.title").value(testBook.getTitle()))                .andExpect(jsonPath("$.author").value(testBook.getAuthor()));    }    @Test    void createBookItem() throws Exception {        when(bookService.saveBookItem(any(BookItem.class), eq(1L), eq(testAccessToken)))                .thenReturn(testBookItem);        mockMvc.perform(                        post("/books/1/items/add")                                .header("Authorization", testAccessToken)                                .contentType(MediaType.APPLICATION_JSON)                                .content(objectMapper.writeValueAsString(testBookItem)))                .andExpect(status().isCreated())                .andExpect(jsonPath("$.id").value(testBookItem.getId()))                .andExpect(jsonPath("$.condition").value(testBookItem.getCondition().toString()))                .andExpect(jsonPath("$.location").value(testBookItem.getLocation()));    }    @Test    void getAllBookItems() throws Exception {        List<BookItem> bookItems = Collections.singletonList(testBookItem);        when(bookService.getAllBookItems(eq(1L))).thenReturn(bookItems);        mockMvc.perform(get("/books/1/items"))                .andExpect(status().isOk())                .andExpect(jsonPath("$[0].id").value(testBookItem.getId()))                .andExpect(jsonPath("$[0].condition").value(testBookItem.getCondition().toString()))                .andExpect(jsonPath("$[0].location").value(testBookItem.getLocation()));    }    @Test    void getBookItem() throws Exception {        when(bookService.getBookItem(eq(1L), eq(1L))).thenReturn(testBookItem);        mockMvc.perform(get("/books/1/items/1"))                .andExpect(status().isOk())                .andExpect(jsonPath("$.id").value(testBookItem.getId()))                .andExpect(jsonPath("$.condition").value(testBookItem.getCondition().toString()))                .andExpect(jsonPath("$.location").value(testBookItem.getLocation()));    }    @Test    void searchBookItems() throws Exception {        List<BookItem> bookItems = Collections.singletonList(testBookItem);        when(bookService.searchBookItems(eq(1L), eq("Москва"), eq("MINIMAL_WEAR")))                .thenReturn(bookItems);        mockMvc.perform(                        get("/books/1/items/search")                                .param("location", "Москва")                                .param("condition", "MINIMAL_WEAR"))                .andExpect(status().isOk())                .andExpect(jsonPath("$[0].id").value(testBookItem.getId()))                .andExpect(jsonPath("$[0].condition").value(testBookItem.getCondition().toString()))                .andExpect(jsonPath("$[0].location").value(testBookItem.getLocation()));    }}